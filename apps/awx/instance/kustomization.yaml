apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: awx

resources:
  - secrets.yaml
  - awx.yaml

patches:
  - target:
      kind: StatefulSet
      name: awx-postgres-15
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: awx-postgres-15
      spec:
        template:
          spec:
            securityContext:
              fsGroup: 26
            initContainers:
              - name: fix-postgres-permissions
                image: busybox:1.36
                command:
                  - sh
                  - -c
                  - |
                    chown -R 26:26 /var/lib/pgsql/data || true
                    chmod -R g+rwX /var/lib/pgsql/data || true
                securityContext:
                  runAsUser: 0
                volumeMounts:
                  - name: postgres-15
                    mountPath: /var/lib/pgsql/data
